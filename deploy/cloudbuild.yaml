steps:
  # Build and push Docker image using Cloud Build
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'buildx'
      - 'build'
      - '--platform=linux/amd64'
      - '--secret'
      - 'id=npm_token,env=NPM_TOKEN'
      - '-f'
      - 'deploy/docker/Dockerfile'
      - '-t'
      - 'gcr.io/$PROJECT_ID/mew:$SHORT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/mew:latest'
      - '--push'
      - '.'
    secretEnv: ['NPM_TOKEN']

# Fetch NPM_TOKEN from Secret Manager
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/npm-token/versions/latest
      env: 'NPM_TOKEN'

# Use high-performance machine type for faster builds
options:
  machineType: 'E2_HIGHCPU_32'  # 32 vCPUs, 32GB RAM
  diskSizeGb: 100
  logging: CLOUD_LOGGING_ONLY

# Longer timeout for large build
timeout: '3600s'  # 1 hour max
